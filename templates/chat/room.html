{% extends 'base.html' %}
{% load static %}

{% block title %} Conversation with the nurse{% endblock %}

{% block content %}
<link rel="stylesheet" href="{% static 'css/chat.css' %}">

<div class="card chat-card">
    
    <div class="chat-header">
        <div>
            <strong>Conversation with the nurse</strong>
            <span class="status-dot">â— connected</span>
        </div>
        
        <form action="{% url 'logout' %}" method="post" style="margin: 0;">
            {% csrf_token %}
            <button type="submit" style="background: none; border: 1px solid #dc3545; color: #dc3545; padding: 5px 10px; border-radius: 5px; cursor: pointer; font-size: 0.8em;">
                Logout
            </button>
        </form>
    </div>

    <!-- Ù…Ù†Ø·Ù‚Ø© Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ -->
    <div id="chat-log">
        {% for message in chat_messages %}
            <!-- Ù†Ø³ØªØ®Ø¯Ù… message.id Ù„Ø±Ø¨Ø· Ø§Ù„Ù€ div Ø¨Ù†ÙØ³ Ø§Ù„Ù€ ID Ø§Ù„Ù‚Ø§Ø¯Ù… Ù…Ù† Ø§Ù„Ø¬Ø§ÙØ§Ø³ÙƒØ±ÙŠØ¨Øª -->
            <div id="msg-{{ message.id }}" class="message {% if message.sender == user %}sent{% else %}received{% endif %}">

                <!-- Ø¥Ø¶Ø§ÙØ© ÙƒÙ„Ù…Ø© Nurse Ù„Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ù…Ù…Ø±Ø¶ -->
                {% if message.sender != user %}
                    <span class="sender-label">Nurse ğŸ‘©â€âš•ï¸</span>
                {% endif %}
                
                <!-- ÙØ­Øµ: Ù‡Ù„ Ø§Ù„Ø±Ø³Ø§Ù„Ø© ØµÙˆØ±Ø© Ø£Ù… Ù†ØµØŸ -->
                {% if message.image %}
                    <!-- Ø§Ù„ØµÙˆØ±Ø© ØªØ¸Ù‡Ø± ÙˆØ§Ø¶Ø­Ø© -->
                    <a href="{{ message.image.url }}" target="_blank">
                        <img src="{{ message.image.url }}" class="chat-image">
                    </a>
                {% else %}
                    <!-- Ø¹Ø±Ø¶ Ø§Ù„Ù†Øµ -->
                    {% if message.sender == user %}
                        {{ message.text_original }}
                    {% else %}
                        {{ message.text_translated|default:message.text_original }}
                    {% endif %}
                {% endif %}

                <span class="time">{{ message.timestamp|date:"Y-m-d / H:i" }}</span>
            </div>
        {% endfor %}
    </div>

    <!-- Ø´Ø±ÙŠØ· Ø§Ù„Ø®Ø·Ø£ (Ù„Ù„ØªÙ†Ø¨ÙŠÙ‡ Ø¹Ù†Ø¯ Ø³Ø±Ø¹Ø© Ø§Ù„Ø¥Ø±Ø³Ø§Ù„) -->
    <div id="error-banner" style="display: none; background-color: #ffebee; color: #c62828; padding: 10px; text-align: center; border-top: 1px solid #ef9a9a; font-size: 0.9em; font-weight: bold;"></div>

    <!-- Ù…Ù†Ø·Ù‚Ø© Ø§Ù„ÙƒØªØ§Ø¨Ø© (ØªÙ… ØªØ¹Ø¯ÙŠÙ„Ù‡Ø§ Ù„Ø¹Ø±Ø¶ Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ø®ØµÙˆØµÙŠØ©) -->
    <div class="chat-input-area" style="flex-direction: column; gap: 0;">
        
        <!-- Ø§Ù„ØµÙ Ø§Ù„Ø¹Ù„ÙˆÙŠ: Ø§Ù„Ø£Ø²Ø±Ø§Ø± ÙˆØ­Ù‚Ù„ Ø§Ù„ÙƒØªØ§Ø¨Ø© -->
        <div style="display: flex; width: 100%; gap: 10px; margin-bottom: 5px;">
            <input type="file" id="image-input" accept="image/*" style="display: none;">
            <button id="image-btn" title="Send image">ğŸ“</button>

            <input id="chat-message-input" type="text" placeholder="Write your message here..." style="flex: 1; padding: 10px; border-radius: 20px; border: 1px solid #ccc;">
            <button id="chat-message-submit" class="btn-primary" style="margin: 0; padding: 0 20px; border-radius: 20px;">â¤</button>
        </div>

        <!-- Ø§Ù„ØµÙ Ø§Ù„Ø³ÙÙ„ÙŠ: Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ø®ØµÙˆØµÙŠØ© Ø§Ù„Ù…ØªØºÙŠØ±Ø© Ø­Ø³Ø¨ Ø§Ù„Ù„ØºØ© -->
        <div style="text-align: center; font-size: 0.75rem; color: #eb6d07; padding-bottom: 5px;">
            {{ privacy_warning }}
        </div>
    </div>
</div>

<script src="{% static 'js/chat.js' %}"></script>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        initChat({
            sessionId: "{{ session.id }}",
            // Ù…Ù„Ø§Ø­Ø¸Ø©: Ø¥Ø°Ø§ ÙƒØ§Ù† User ID Ø¹Ø¨Ø§Ø±Ø© Ø¹Ù† UUIDØŒ ÙŠÙØ¶Ù„ Ø¥Ø²Ø§Ù„Ø© parseInt ÙˆØ§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„ØªÙ†ØµÙŠØµ ÙÙ‚Ø· "{{ user.id }}"
            // Ù„ÙƒÙ† Ø¥Ø°Ø§ ÙƒØ§Ù† Ø±Ù‚Ù…Ø§Ù‹ (Integer) ÙƒÙ…Ø§ Ù‡Ùˆ Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØŒ ÙØ§Ù„ÙƒÙˆØ¯ Ø§Ù„Ø­Ø§Ù„ÙŠ ØµØ­ÙŠØ­.
            userId: parseInt("{{ user.id }}"),
            
            // ØªÙ…Ø±ÙŠØ± ØªÙˆÙƒÙ† Ø§Ù„Ø­Ù…Ø§ÙŠØ© ÙˆØ±Ø§Ø¨Ø· Ø§Ù„Ø±ÙØ¹ Ù„Ù„Ù€ JS
            csrfToken: "{{ csrf_token }}",
            uploadUrl: "{% url 'chat_upload_image' %}"
        });
    });
</script>

{% endblock %}